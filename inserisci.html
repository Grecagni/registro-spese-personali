<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1">
<title>➕ Inserisci spesa</title>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
<link rel="preconnect" href="https://www.gstatic.com" crossorigin>
<link rel="preconnect" href="https://identitytoolkit.googleapis.com" crossorigin>
<link rel="preconnect" href="https://firestore.googleapis.com" crossorigin>
  <link rel="manifest" href="manifest.webmanifest">
<link rel="stylesheet" href="css/style.css">
<meta name="robots" content="noindex">
</head>
<body>
  <div id="navbar"></div>
  <!-- Navbar -->

  <div class="container mt-2" style="max-width:700px">
    <div id="msg"></div>

    <form id="formSpesa" class="mt-3">
      <!-- BASE -->
      <div class="row g-3">
        <div class="col-12 col-sm-6">
          <label class="form-label" for="data">Data</label>
          <input id="data" type="date" class="form-control" required>
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label" for="categoria">Categoria</label>
          <select id="categoria" class="form-select" required>
            <option value="Cibo">Cibo</option>
            <option value="Casa">Casa</option>
            <option value="Trasporti">Trasporti</option>
            <option value="Svago">Svago</option>
            <option value="Salute">Salute</option>
            <option value="Altro" selected>Altro</option>
          </select>
        </div>
        <div class="col-12">
          <label class="form-label" for="descrizione">Descrizione</label>
          <input id="descrizione" type="text" class="form-control" required>
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label" for="importo">Importo (€)</label>
          <input id="importo" type="number" step="0.01" min="0" class="form-control" required>
        </div>
        <div class="col-12 col-sm-6">
          <label class="form-label" for="etichette">Etichette (separate da virgola)</label>
          <input id="etichette" type="text" class="form-control" placeholder="es. fisso, abbonamento">
        </div>
      </div>

      <hr class="my-3">

      <!-- SWITCH RICORRENTE -->
      <div class="form-check form-switch mb-2">
        <input class="form-check-input" type="checkbox" id="recSwitch">
        <label class="form-check-label" for="recSwitch">Ricorrente</label>
      </div>

      <!-- PANNELLO RICORRENZA -->
      <div id="recPanel" class="border rounded p-3" style="display:none;">
        <div class="row g-3">
          <div class="col-12 col-sm-6">
            <label class="form-label" for="recFreq">Frequenza</label>
            <select id="recFreq" class="form-select">
              <option value="monthly" selected>Mensile</option>
              <option value="weekly">Settimanale</option>
              <option value="yearly">Annuale</option>
            </select>
          </div>
          <div class="col-12 col-sm-6">
            <label class="form-label" for="recInterval">Intervallo</label>
            <input id="recInterval" type="number" min="1" value="1" class="form-control">
            <div class="form-text">Es. ogni <b>1</b> mese / ogni <b>2</b> settimane</div>
          </div>

          <div class="col-12 col-sm-6">
            <label class="form-label" for="recStart">Data inizio</label>
            <input id="recStart" type="date" class="form-control">
          </div>
          <div class="col-12 col-sm-6">
            <label class="form-label" for="recEnd">Data fine (opz.)</label>
            <input id="recEnd" type="date" class="form-control">
          </div>

          <!-- Weekly -->
          <div class="col-12 col-sm-6 rec-weekly d-none">
            <label class="form-label" for="recWeekday">Giorno della settimana</label>
            <select id="recWeekday" class="form-select">
              <option value="1">Lunedì</option><option value="2">Martedì</option>
              <option value="3">Mercoledì</option><option value="4">Giovedì</option>
              <option value="5">Venerdì</option><option value="6">Sabato</option>
              <option value="7">Domenica</option>
            </select>
          </div>

          <!-- Monthly -->
          <div class="col-12 col-md-4 rec-monthly">
            <label class="form-label" for="recMonthlyMode">Mensile: modalità</label>
            <select id="recMonthlyMode" class="form-select">
              <option value="giorno_fisso" selected>Giorno fisso</option>
              <option value="ultimo_giorno">Ultimo giorno</option>
            </select>
          </div>
          <div class="col-6 col-md-4 rec-monthly rec-monthly-day">
            <label class="form-label" for="recDay">Giorno (1–31)</label>
            <input id="recDay" type="number" min="1" max="31" class="form-control">
          </div>

          <!-- Yearly -->
          <div class="col-6 rec-yearly d-none">
            <label class="form-label" for="recADay">Giorno</label>
            <input id="recADay" type="number" min="1" max="31" class="form-control">
          </div>
          <div class="col-6 rec-yearly d-none">
            <label class="form-label" for="recAMonth">Mese</label>
            <input id="recAMonth" type="number" min="1" max="12" class="form-control">
          </div>

          <div class="col-12 col-sm-6">
            <label class="form-label" for="recStatus">Stato</label>
            <select id="recStatus" class="form-select">
              <option value="active" selected>Attiva</option>
              <option value="paused">In pausa</option>
            </select>
          </div>

          <div class="col-12">
            <div class="form-check">
              <input class="form-check-input" type="checkbox" id="recGenerateNow" checked>
              <label class="form-check-label" for="recGenerateNow">Genera subito le prossime istanze</label>
            </div>
          </div>
        </div>
      </div>

      <button id="saveBtn" class="btn btn-primary w-100 mt-3" type="submit">Salva</button>
    </form>
  </div>

<script type="module" src="js/navbar.js"></script>
  <script type="module">
    import { requireAuth } from "./js/auth.js";
    import { addSpesa, addSerieRicorrente, materializeSerie } from "./js/spese.js";
    requireAuth();

    // default oggi
    const today = new Date();
    const todayYMD = today.toISOString().slice(0,10);
    document.getElementById("data").value = todayYMD;
    document.getElementById("recStart").value = todayYMD;

    // UI ricorrenza
    const recSwitch = document.getElementById("recSwitch");
    const recPanel  = document.getElementById("recPanel");
    const recFreq   = document.getElementById("recFreq");
    const recMonthlyMode = document.getElementById("recMonthlyMode");

    // set default giorno mensile = giorno della data
    document.getElementById("recDay").value = new Date(todayYMD).getDate();

    recSwitch.addEventListener("change", () => {
      recPanel.style.display = recSwitch.checked ? "block" : "none";
    });

    function updateRecVisibility() {
      const f = recFreq.value;
      document.querySelectorAll(".rec-weekly").forEach(e => e.classList.toggle("d-none", f!=="weekly"));
      document.querySelectorAll(".rec-monthly").forEach(e => e.classList.toggle("d-none", f!=="monthly"));
      document.querySelectorAll(".rec-yearly").forEach(e => e.classList.toggle("d-none", f!=="yearly"));
      document.querySelectorAll(".rec-monthly-day").forEach(e => e.classList.toggle("d-none", !(f==="monthly" && recMonthlyMode.value==="giorno_fisso")));
    }
    recFreq.addEventListener("change", updateRecVisibility);
    recMonthlyMode.addEventListener("change", updateRecVisibility);
    updateRecVisibility();

    const form = document.getElementById("formSpesa");
    const msg  = document.getElementById("msg");
    const btn  = document.getElementById("saveBtn");

    form.addEventListener("submit", async (e) => {
      e.preventDefault();
      msg.innerHTML = "";
      btn.disabled = true;

      try {
        const base = {
          data: document.getElementById("data").value,
          descrizione: document.getElementById("descrizione").value.trim(),
          importo: document.getElementById("importo").value,
          categoria: document.getElementById("categoria").value,
          etichette: document.getElementById("etichette").value
        };
        if (!base.data || !base.descrizione || !base.importo) throw new Error("Compila i campi obbligatori.");

        if (!recSwitch.checked) {
          // Spesa singola
          await addSpesa(base);
          form.reset();
          document.getElementById("data").value = todayYMD;
          msg.innerHTML = `<div class="alert alert-success">Spesa salvata!</div>`;
        } else {
          // Serie ricorrente
          const serieInput = {
            ...base,
            startDate: document.getElementById("recStart").value || base.data,
            endDate: document.getElementById("recEnd").value || null,
            frequenza: document.getElementById("recFreq").value,
            interval: document.getElementById("recInterval").value || 1,
            status: document.getElementById("recStatus").value,

            // specifici
            weekday: document.getElementById("recWeekday").value,
            monthlyMode: document.getElementById("recMonthlyMode").value,
            anchorDay: document.getElementById("recDay").value,
            anchorMonth: document.getElementById("recAMonth").value,
          };

          // Normalizza per frequenza
          if (serieInput.frequenza === "weekly") {
            if (!serieInput.weekday) throw new Error("Seleziona il giorno della settimana.");
          }
          if (serieInput.frequenza === "monthly") {
            if (!serieInput.monthlyMode) throw new Error("Seleziona la modalità mensile.");
            if (serieInput.monthlyMode === "giorno_fisso" && !serieInput.anchorDay) {
              throw new Error("Inserisci il giorno del mese.");
            }
          }
          if (serieInput.frequenza === "yearly") {
            if (!serieInput.anchorDay || !serieInput.anchorMonth) {
              throw new Error("Completa giorno e mese per ricorrenza annuale.");
            }
          }

          const serie = await addSerieRicorrente(serieInput);

          if (document.getElementById("recGenerateNow").checked) {
            const res = await materializeSerie(serie.id);
            msg.innerHTML = `<div class="alert alert-success">Serie salvata! Generate ${res.created} istanze future.</div>`;
          } else {
            msg.innerHTML = `<div class="alert alert-success">Serie salvata! Potrai generare le istanze dalla pagina “Ricorrenti”.</div>`;
          }

          form.reset();
          document.getElementById("data").value = todayYMD;
          document.getElementById("recStart").value = todayYMD;
          recPanel.style.display = "none";
        }
      } catch (err) {
        msg.innerHTML = `<div class="alert alert-danger">${err.message}</div>`;
      } finally {
        btn.disabled = false;
      }
    });
  </script>
  <script src="js/sw.js"></script>
</body>
</html>
